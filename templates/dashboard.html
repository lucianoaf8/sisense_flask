{% extends "base.html" %}

{% block title %}Dashboard - Sisense Flask Integration{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="grid">
        <!-- Connection Status Card -->
        <div class="card">
            <h2>Connection Status</h2>
            <div class="form-group">
                <label>Authentication Status:</label>
                <div id="auth-status">
                    <span class="badge badge-warning">Checking...</span>
                </div>
            </div>
            <div class="form-group">
                <label>Sisense URL:</label>
                <input type="text" class="form-control" value="{{ sisense_url }}" readonly>
            </div>
            <div class="form-group">
                <button class="btn btn-primary refresh-btn" data-target="auth">
                    Refresh Status
                </button>
                <button class="btn btn-success" onclick="window.sisenseUI.handleAuth(event)" id="test-connection">
                    Test Connection
                </button>
            </div>
        </div>

        <!-- Quick Stats Card -->
        <div class="card">
            <h2>Quick Stats</h2>
            <div id="quick-stats">
                <div class="mb-3">
                    <strong>Dashboards:</strong> <span id="dashboard-count">-</span>
                </div>
                <div class="mb-3">
                    <strong>Data Models:</strong> <span id="model-count">-</span>
                </div>
                <div class="mb-3">
                    <strong>Connections:</strong> <span id="connection-count">-</span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="loadQuickStats()">
                    Load Stats
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Activity Card -->
    <div class="card">
        <h2>Recent Activity</h2>
        <div id="recent-activity">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Resource</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log">
                        <tr>
                            <td colspan="4" class="text-center">No recent activity</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quick Actions Card -->
    <div class="card">
        <h2>Quick Actions</h2>
        <div class="grid">
            <div>
                <h3>Data Exploration</h3>
                <div class="mb-3">
                    <a href="{{ url_for('data_models') }}" class="btn btn-primary">
                        Browse Data Models
                    </a>
                </div>
                <div class="mb-3">
                    <a href="{{ url_for('dashboards') }}" class="btn btn-primary">
                        View Dashboards
                    </a>
                </div>
            </div>
            <div>
                <h3>Query Tools</h3>
                <div class="mb-3">
                    <a href="{{ url_for('query_sql') }}" class="btn btn-success">
                        Execute SQL Query
                    </a>
                </div>
                <div class="mb-3">
                    <a href="{{ url_for('query_jaql') }}" class="btn btn-success">
                        Execute JAQL Query
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Check Card -->
    <div class="card">
        <h2>System Health</h2>
        <div id="health-check">
            <div class="form-group">
                <button class="btn btn-primary" onclick="performHealthCheck()">
                    Run Health Check
                </button>
            </div>
            <div id="health-results"></div>
        </div>
    </div>
</div>

<form id="auth-form" style="display: none;">
    <!-- Hidden form for authentication testing -->
</form>
{% endblock %}

{% block scripts %}
<script>
async function loadQuickStats() {
    try {
        // Load dashboards count
        const dashboardsResponse = await fetch('/api/dashboards');
        if (dashboardsResponse.ok) {
            const dashboards = await dashboardsResponse.json();
            document.getElementById('dashboard-count').textContent = dashboards.count || 0;
        }

        // Load data models count
        const modelsResponse = await fetch('/api/datamodels');
        if (modelsResponse.ok) {
            const models = await modelsResponse.json();
            document.getElementById('model-count').textContent = models.count || 0;
        }

        // Load connections count
        const connectionsResponse = await fetch('/api/connections');
        if (connectionsResponse.ok) {
            const connections = await connectionsResponse.json();
            document.getElementById('connection-count').textContent = connections.count || 0;
        }
    } catch (error) {
        console.error('Failed to load quick stats:', error);
    }
}

async function performHealthCheck() {
    const resultsDiv = document.getElementById('health-results');
    resultsDiv.innerHTML = '<div class="spinner"></div>';
    
    try {
        const response = await fetch('/health');
        const data = await response.json();
        
        let html = '<div class="mt-3">';
        html += `<div class="alert alert-${data.status === 'healthy' ? 'success' : 'danger'}">`;
        html += `<strong>Status:</strong> ${data.status}<br>`;
        html += `<strong>Authentication:</strong> ${data.authentication}<br>`;
        html += `<strong>Sisense URL:</strong> ${data.sisense_url}<br>`;
        html += `<strong>Timestamp:</strong> ${new Date(data.timestamp * 1000).toLocaleString()}`;
        html += '</div>';
        
        if (data.error) {
            html += `<div class="alert alert-warning"><strong>Error:</strong> ${data.error}</div>`;
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger mt-3">Health check failed: ${error.message}</div>`;
    }
}

// Auto-load stats when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadQuickStats();
});
</script>
{% endblock %}